{"version":3,"file":"CORE_PerSecond_Limiter.js","sourceRoot":"","sources":["../../../../../src/private/core/requestPerSecondLimit/CORE_PerSecond_Limiter.ts"],"names":[],"mappings":"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","sourcesContent":["// tslint:disable: prefer-array-literal\n// tslint:disable: only-arrow-functions\n// tslint:disable: promise-function-async\n// tslint:disable: no-any\n// tslint:disable: no-any\n// tslint:disable: ban-types\n// tslint:disable: ter-prefer-arrow-callback\nimport { CallBack } from '../../../typescript';\nimport { perSeconds, void0 } from '../../../utils';\n\nlet lastCall = Date.now();\nconst lastDelay = () => Date.now() - lastCall;\n// const toMilihertz = (hz: number) => hz / 1000;\nconst resetLastCall = () => {\n  lastCall = Date.now();\n};\n(async () => {\n  //\n  // const now = Date.now();\n\n  lastCall = Date.now();\n\n  return void 0;\n})().catch(error => console.log('error message:', error.message));\nfunction requestLimiterFactory() {\n  let isCalled = false;\n  const callsQueue: [Function, CallBack<any>][] = [];\n  return function requestLimiter(fn: Function, hertz: number = 1) {\n    const callToPop = async function(): Promise<void> {\n      if (callsQueue.length >= 1 && !isCalled) {\n        isCalled = true;\n        setTimeout(async function(): Promise<void> {\n          isCalled = false;\n          await callToPop();\n          return void 0;\n        }, perSeconds(hertz));\n        const poped = callsQueue.pop();\n        const [myfn, mycb] = !!poped ? poped : [neverWillCb, neverCb];\n\n        while (lastDelay() < perSeconds(hertz));\n        {\n          // do nothing just wait while (lastDelay() < perSeconds(hertz));\n        }\n        mycb(null, myfn());\n        resetLastCall();\n        return void 0;\n      }\n      return void 0;\n    };\n\n    return async function addToQueue(cb: CallBack<any>): Promise<void> {\n      callsQueue.unshift([fn, cb]);\n      callToPop();\n      return void 0;\n    };\n  };\n}\n\nexport const myPromisify = <T>(addToQueue: (cb: any) => Promise<void>) => {\n  return new Promise<T>((resolve, reject) => {\n    addToQueue((error: Error, result: any) => {\n      if (!!error) {\n        console.error(error);\n\n        reject(error);\n        return void 0;\n      }\n      resolve(result);\n      return void 0;\n    });\n  });\n};\n\nfunction limitingRequest(limiterFactory: ReqLimiterFactory) {\n  const requestLimiter = limiterFactory();\n  return (hz: number) => async <T>(fn: () => T) => {\n    const addToQueue = requestLimiter(fn, hz);\n    return myPromisify<T>(addToQueue);\n  };\n}\n\nconst neverWillCb = async () => {\n  void0();\n  throw new Error(\n    'NEVER: lenght is validated prior to pop this should never occur'\n  );\n};\n\nconst neverCb = (error: Error | null, returnValue: any) => {\n  void0({ returnValue, error });\n  throw new Error(\n    'NEVER: lenght is validated prior to pop this should never occur'\n  );\n};\n\nexport const requestPerSecondLimiter = limitingRequest(requestLimiterFactory);\nexport type ReqLimiterFactory = () => (\n  fn: Function,\n  hertz?: number\n) => (cb: CallBack<any>) => Promise<void>;\n"]}